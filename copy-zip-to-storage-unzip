#!/bin/bash

# Azure CLI script to upload and extract ALL zip files from a folder to blob storage
# Running from Azure compute instance - uses managed identity authentication

# Configuration
STORAGE_ACCOUNT="your_storage_account_name"
CONTAINER_NAME="your_container_name"
ZIP_FOLDER_PATH="/path/to/your/zip/files/folder"
TEMP_EXTRACT_DIR="/tmp/extracted_files"

# Set SAS token (get from Azure portal or generate programmatically)
export AZURE_STORAGE_SAS_TOKEN="your_sas_token_here"

# Function to upload and extract zip file
upload_and_extract_zip() {
    local zip_file=$1
    local container=$2
    local storage_account=$3
    
    echo "Processing zip file: $zip_file"
    
    # Create unique temporary directory for this zip file
    local temp_dir="${TEMP_EXTRACT_DIR}/$(basename "$zip_file" .zip)"
    mkdir -p "$temp_dir"
    
    # Extract zip file
    echo "Extracting zip file..."
    unzip -q "$zip_file" -d "$temp_dir"
    
    if [ $? -eq 0 ]; then
        # Get zip filename without extension for folder structure
        zip_basename=$(basename "$zip_file" .zip)
        
        # Check if extraction created a single root folder with same name as zip
        local extracted_items=($(ls -1 "$temp_dir"))
        local upload_source="$temp_dir"
        local destination_path="$zip_basename"
        
        if [ ${#extracted_items[@]} -eq 1 ] && [ -d "$temp_dir/${extracted_items[0]}" ] && [ "${extracted_items[0]}" = "$zip_basename" ]; then
            echo "Detected single root folder with same name as zip - avoiding duplicate path"
            # Upload contents of the inner folder directly
            upload_source="$temp_dir/${extracted_items[0]}"
            destination_path="$zip_basename"
        fi
        
        # Upload extracted files to blob storage
        echo "Uploading files to blob storage..."
        az storage blob upload-batch \
            --destination "$container" \
            --source "$upload_source" \
            --destination-path "$destination_path" \
            --account-name "$storage_account"
        
        if [ $? -eq 0 ]; then
            echo "Successfully uploaded and extracted: $zip_file"
        else
            echo "Error uploading files from: $zip_file"
        fi
    else
        echo "Error extracting zip file: $zip_file"
    fi
    
    # Clean up temporary directory for this zip
    rm -rf "$temp_dir"
}

# Check if zip folder exists
if [ ! -d "$ZIP_FOLDER_PATH" ]; then
    echo "Error: ZIP folder does not exist: $ZIP_FOLDER_PATH"
    exit 1
fi

# Create container if it doesn't exist
echo "Creating container if it doesn't exist..."
az storage container create \
    --name "$CONTAINER_NAME" \
    --account-name "$STORAGE_ACCOUNT"

# Count zip files
zip_count=$(find "$ZIP_FOLDER_PATH" -maxdepth 1 -name "*.zip" | wc -l)
echo "Found $zip_count zip files to process"

if [ $zip_count -eq 0 ]; then
    echo "No zip files found in: $ZIP_FOLDER_PATH"
    exit 1
fi

# Create main temp directory
mkdir -p "$TEMP_EXTRACT_DIR"

# Process all zip files in the specified folder
for zip_file in "$ZIP_FOLDER_PATH"/*.zip; do
    if [ -f "$zip_file" ]; then
        upload_and_extract_zip "$zip_file" "$CONTAINER_NAME" "$STORAGE_ACCOUNT"
    fi
done

# Clean up main temp directory
rm -rf "$TEMP_EXTRACT_DIR"

echo "Script completed successfully - processed $zip_count zip files"
